# 单聊流程

![单聊](src/main/resources/picture/单聊.png)

> 流程

- A 要和 B 聊天，首先 A 和 B 需要与服务器建立连接，然后进行一次登录流程，服务端保存用户标识和 TCP 连接的映射关系
- A 发消息给 B，首先需要将带有 B 标识的消息数据包发送到服务器，然后服务器从消息数据包中拿到 B 的标识，找到对应的 B 的连接，将消息发送给 B
- 任意一方发消息给对方，如果对方不在线，需要将消息缓存，对方上线之后再发送

**客户端与服务端之间相互通信的数据包称为指令数据包，指令数据包分为指令和数据，每一种指令对应客户端或者服务端的一种操作，数据部分对应的是指令处理需要的数据**

![单聊指令](src/main/resources/picture/单聊指令.png)

> 指令列表

|指令内容|客户端|服务端|
|  ----  | ----  | ----  |
|登录请求|发送|接收|
|登录响应|接收|发送|
|客户端发消息|发送|接收|
|服务端发消息|接收|发送|
|登出请求|发送|接收|
|登出响应|接收|发送|

# 群聊流程

> 群聊指的是一个组内多个用户之间的聊天，一个用户发到群组的消息会被组内任何一个成员接收

![群聊](src/main/resources/picture/群聊.png)

- A，B，C 依然会经历登录流程，服务端保存用户标识对应的 TCP 连接
- A 发起群聊的时候，将 A，B，C 的标识发送至服务端，服务端拿到之后建立一个群聊 ID，然后把这个 ID 与 A，B，C 的标识绑定
- 群聊里面任意一方在群里聊天的时候，将群聊 ID 发送至服务端，服务端拿到群聊 ID 之后，取出对应的用户标识，遍历用户标识对应的 TCP 连接，就可以将消息发送至每一个群聊成员

> 指令集

![群聊指令](src/main/resources/picture/群聊指令.png)

|指令内容|客户端|服务端|
|  ----  | ----  | ----  |
|创建群聊请求|发送|	接收|
|群聊创建成功通知|	接收|	发送|
|加入群聊请求|	发送|	接收|
|群聊加入通知|	接收|	发送|
|发送群聊消息|	发送|	接收|
|接收群聊消息	|接收|	发送|
|退出群聊请求	|发送|	接收|
|退出群聊通知|	接收|	发送|

# Netty

## 客户端使用 Netty

![客户端使用 Netty](src/main/resources/picture/客户端netty.png)

- 首先，客户端会解析控制台指令，比如发送消息或者建立群聊等指令
- 然后，客户端会基于控制台的输入创建一个指令对象，用户告诉服务端具体要干什么事情
- TCP 通信需要的数据格式为二进制，因此，接下来通过自定义二进制协议将指令对象封装成二进制，这一步称为协议的编码
- 对于收到服务端的数据，首先需要截取出一段完整的二进制数据包
- 将此二进制数据包解析成指令对象，比如收到消息
- 将指令对象送到对应的逻辑处理器来处理

## 服务端使用 Netty

![服务端使用 Netty](src/main/resources/picture/服务端netty.png)